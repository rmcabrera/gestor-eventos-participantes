apiVersion: v1
kind: ConfigMap
metadata:
  name: eventos-init-scripts
  namespace: gestion-ep-dev
data:
  init_schema_eventos.sql: |
    ALTER SESSION SET CONTAINER = XEPDB1;

    DECLARE
      user_exists NUMBER := 0;
    BEGIN
      SELECT COUNT(*) INTO user_exists FROM dba_users WHERE username = 'MS_EVENTOS';
      IF user_exists = 0 THEN
        EXECUTE IMMEDIATE 'CREATE USER ms_eventos IDENTIFIED BY eventos123';
        EXECUTE IMMEDIATE 'GRANT CONNECT, RESOURCE TO ms_eventos';
        EXECUTE IMMEDIATE 'ALTER USER ms_eventos QUOTA UNLIMITED ON USERS';
      END IF;
    END;
    /

    BEGIN
      EXECUTE IMMEDIATE '
        CREATE TABLE ms_eventos.evento (
          id           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          nombre       VARCHAR2(100) NOT NULL,
          descripcion  VARCHAR2(255),
          fecha_inicio DATE NOT NULL,
          fecha_fin    DATE,
          lugar        VARCHAR2(150),
          cupo_maximo  NUMBER,
          creado_en    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )';
    EXCEPTION
      WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
          NULL; 
        ELSE
          RAISE;
        END IF;
    END;
    /

    COMMIT;
